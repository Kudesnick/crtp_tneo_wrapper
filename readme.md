# CRTP TNeo Wrapper

C++ обертка над [TNeo] и другими библиотеками для стартового проекта на базе МК с архитектурой Cortex M.

## Цель

Иметь стартовый проект с базовым функционалом, который можно нарастить или оперативно убрать для реализации того или иного бизнес-решения. В качестве основных критериев данного проекта выступает:

- Отсутствие проприетарных библиотек. Данное решение позволяет гибко модифицировать и достраивать имеющиеся библиотечные решения, не нагружать приложение избыточным кодом.
- Использование компактных библиотек, реализующих необходимый функционал. Компактность и понятность кода ставится выше, чем универсальность, большое количество настроек и развитое комьюнити. Даже если библиотека давно не развивается, но обладает необходимым функционалом и её код понятен и прост, выбор будет сделан в её ползу, а не в пользу современного динамично развивающегося продукта.
- Возможность реализации бизнес-логики на C++. Классы, метапрограммирование и пр. дают возможность писать более безопасный код, нежели на чистом C++. однако, такой подход требует больше усилий со стороны программиста нижележащих слоев абстракции. Так, бездумное (хотя очень удобное) использование абстрактных классов непомерно увеличивает расход памяти (как RAM так и ROM), что критично для МК. В противовес этому идиома [CRTP] мозволяет использовать преимущества классов, без лишнего оверхеда.
- Удобство отладки кода. Упор сделан на проприетарное решение на основе [`*.scvd`][SCVD] файлов. Но идеи, положенные в основу, можно будет позже переложить на что-то более открытое.

Однако, хочу сделать оговорку, что данные цели не распространяются на выбор инструментов разработчика. В частности, в качестве среды разработки был выбран продукт Keil uVision, а в качестве отладчика используется SEGGER J-Link. Данное решение продиктовано удобством отладки и низким порогом вхождения в работу с данными инструмнтами. Вопрос правильности выбора выходит за рамки данного проекта. Можно считать, что выбор продиктован личными предпочтениями разработчика и доступностью для нго данного инструментария.

В конечном итоге планируется реализовать в проекте следующий функционал, завернутый в C++:
- Многозадачности;
- Консольный ввод/вывод через стандартные функции `printf`, `scanf` и т.д.;
- Работа с внешней ФС на SPI-Flash носителе через стандартные функции `fopen`, `fwrite` и т.д.;
- Композитное USB Device устройство 2xADC + MSC;
- Ситема хранения настроек, защищенная от внезапных сбоев по питанию;
- Развитой механизм текстовых диалогов (например, для реализации общения с модемом через AT команды).

[CRTP]: https://ru.wikipedia.org/wiki/Curiously_recurring_template_pattern
[TNeo]: https://dmitryfrank.com/projects/tneo
[SCVD]: https://www.keil.com/pack/doc/compiler/EventRecorder/html/SCVD_Format.html

## Используемые в текущий момент библиотеки

- [TNeo](https://github.com/dimonomid/tneo) - компактная ОС.
- [Segger RTT](https://wiki.segger.com/RTT) - отладочный ввод-вывод через SWD (проприетарное решение, но очень крутое).
- [printf](https://github.com/mpaland/printf) - компактная библиотека стандартного текстового вывода.
- [littlefs](https://github.com/littlefs-project/littlefs) - компактная, защищенная от сбоев по питанию ФС.

## to-do list

&check; - выполнено.

&cross; - не будет выполняться.

- &cross; Реализовать  перегрузку `void *__user_perthread_libspace (void)`, `int _mutex_initialize(mutex *m)`, `void _mutex_acquire(mutex *m)`, `void _mutex_release(mutex *m)`, `void _mutex_free(mutex *m)`.
- &check; Использовать системный стек, как стек прерываний.
- &check; Убрать из os.h аппаратную зависимость (определение системного стека).
- &check; Переместить idle в cpp конструктор.
- &cross; Убрать param из сигнатуры функции.
- &check; Починить отладку.
- &check; Испоьзовать компактную версию printf.
- &check; Защитить мютексом функций ввода-вывода.
- Реализовать round_robin в режиме dynamic tick.
- Протестировать создание мютекса до запуска ОС.
- Добавить возможность отладки мютексов через `*.scvd`.
- Поднять BSP для работы с SPI-FLASH.
- Добавить работу с файловой системой черезстандартные функции.